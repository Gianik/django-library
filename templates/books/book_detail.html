{% extends "partials/base.html"%}
{% block content %}
        
    <article class="media content-section">
        <div class="media-body">
            <h5 id="err" style='color:red;text-align:center;display:none'></h5>
            <div class="article-metadata">
            <small class="text-muted"></small>
                <a class="btn btn-warning btn-sm mt-1 mb-1" id="ub" href="{% url 'book-update' pk %}" hidden >Update</a>
                <a class="btn btn-danger btn-sm mt-1 mb-1" id="db" href="{% url 'book-delete' pk %}" hidden >Delete</a>
                <a class="btn btn-success btn-sm mt-1 mb-1" href="{% url 'book-comment' pk %}">New Comment</a>
                <a class="btn btn-info btn-sm mt-1 mb-1"  style="color:white" id="bb" hidden >Borrow Book</a>
                <a class="btn btn-info btn-sm mt-1 mb-1"  style="color:white" id="rb" hidden >Return Book</a>
            </div>
            <div class="article-metadata" id="div1">
            
            <h2 class="article-title"></h2>
            <small class="text-muted"></small>
            <p class="article-content"></p>
            <p class="article-content"></p>
            <p class="article-content"></p>
            <p class="article-content"></p>
            <p class="article-content"></p>
            </div>
            <div class="article-metadata" id="div3">
            </div>
            <h3>Comments:</h3>
            <div class="article-metadata" id="div2">
            </div>

        </div>
    </article>

{% endblock content %}
{% block javascript %}
<script>

    var pk = {{pk}}
    $.ajax({
        type:"GET",
        url:http+'/book/book-detail/'+pk,
        success:(data)=>{
            console.log(data)
            var html =''
            var html2=''
            var html5=''
            html+="<div class="+'article-metadata'+" ><h2 class="+'article-title'+">Title: " + data.data.title +"</h2> Author: "
            $(data.data.author_tags).each(function(index,value){
                html+="<small class="+'text-muted'+"  >" + value.author + " </small>"
            })
            if(!data.data.checked_out_by){
                $("#bb").removeAttr('hidden');
                html5+="<p class="+'article-content'+" id="+'cb'+">Checkout by: " + "None" + 
                    "</p><p class="+'article-content'+">Owner: " + data.data.owner + "</p>" +
                    "<p class="+'article-content'+">Location: " + data.data.location + "</p><p class="+'article-content'+">Status: " + data.data.status + "</p>" +
                    "<p class="+'article-content'+">Type: " + data.data.type + "</p></div>"

            }
            else{
                html5+="<p class="+'article-content'+" id="+'cb'+" >Checkout by: " + data.data.checked_out_by + 
                    "</p><p class="+'article-content'+">Owner: " + data.data.owner + "</p>" +
                    "<p class="+'article-content'+">Location: " + data.data.location + "</p><p class="+'article-content'+">Status: " + data.data.status + "</p>" +
                    "<p class="+'article-content'+">Type: " + data.data.type + "</p></div>"

            }
            $(data.data.comments).each(function(index,value){
                var date = new Date(value.date_updated)
                var d = date.getDate()
                var m = date.getMonth()+1
                var y = date.getFullYear()
                if(data.data2.id==value.author.id){
                    html2+="Author: <h7 class="+'text-muted'+" >" + value.author.full_name  + "</h7><p><h6 class="+'mr-2'+" >" + value.text + "</h6></p><p>Updated On:<h7 class="+'text-muted'+"  >" + m + "-" + d + "-" + y + "</h7></p>"+
                        "<br><a   href="+http+'/book/update/comment/'+ value.id +"><button type="+'button'+" class="+'btn btn-dark btn-sm'+" style="+'font-size:'+'10px;'+'background-color:'+'#ffc107;'+'color:'+'white'+">Update Comment</button></a>  "+
                        "<a   href="+http+'/book/delete/comment/'+ value.id +"><button type="+'button'+" class="+'btn btn-danger btn-sm'+" style="+'font-size:'+'10px;'+'background-color:'+'#dc3545;'+'color:'+'white'+ "  >Delete Comment</button></a><hr>"
                }
                else{
                    html2+="Author: <h7 class="+'text-muted'+" >" + value.author.full_name  + "</h7><p><h6 class="+'mr-2'+" >" + value.text + "</h6></p><p>Updated On:<h7 class="+'text-muted'+"  >" + m + "-" + d + "-" + y + "</h7></p>"
                }
            })

            $("#div1").append(html)
            $("#div2").append(html2)
            $("#div3").append(html5)

            if(data.data2.full_name===data.data.owner){
                $("#ub").removeAttr('hidden');
                $("#db").removeAttr('hidden');
            }
            if(data.data2.full_name===data.data.checked_out_by){
                $("#rb").removeAttr('hidden');
            }
            $("#rb").click(function(){
                var html3=''
                console.log('test1')
                $.ajax({
                    url: http+"/book/borrow-return/"+pk,
                    type: 'GET',
                    sucess: (data) => {
                        console.log('test')

 
                        
                    },
                    error: (error) => {
                        console.log(error)
                    }
                })
                console.log(data.data2.full_name)
                $("#bb").removeAttr('hidden');
                $("#rb").attr("hidden",true);
                $('#cb').replaceWith("<p class="+'article-content'+" id="+'cb'+" >Checkout by: " + "None" + "</p>")
            }),
            $("#bb").click(function(){
                var html4=''
                console.log(data.data2.full_name)
                console.log('test2')
                $.ajax({
                    url: http+"/book/borrow-return/"+pk,
                    type: 'GET',
                    sucess: (data) => {

                    },  
                    error: (error) => {
                        console.log(error)
                    }
                })
                console.log('test3')
                $("#rb").removeAttr('hidden');
                $("#bb").attr("hidden",true);
                $('#cb').replaceWith("<p class="+'article-content'+" id="+'cb'+" >Checkout by: " + data.data2.full_name + "</p>")
            })
        

        },
        error:(error)=>{
            if(error.status == 404){
                window.location.replace(http+"/")
            }
            else{
                $('#err').show()
                $("#err").html("Server error please refresh and try again")
            }
        },

    })







</script>
      
{% endblock %}